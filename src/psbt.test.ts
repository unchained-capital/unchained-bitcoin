import {
  addSignaturesToPSBT,
  autoLoadPSBT,
  parseSignaturesFromPSBT,
  parseSignatureArrayFromPSBT,
  psbtInputFormatter,
  psbtOutputFormatter,
  translatePSBT,
} from "./psbt";
import { ROOT_FINGERPRINT, TEST_FIXTURES } from "./fixtures";
import {
  generateMultisigFromHex,
  generateMultisigFromPublicKeys,
} from "./multisig";
import { braidConfig } from "./braid";
import { P2WSH } from "./p2wsh";

const MULTISIGS = TEST_FIXTURES.multisigs;
const TRANSACTIONS = TEST_FIXTURES.transactions;

const tx = TRANSACTIONS[0];
const ms = MULTISIGS[0];

describe("psbt", () => {
  describe("psbtInputFormatter", () => {
    it("should return bip32derivation properly", () => {
      const input = MULTISIGS[0].utxos[0];
      input.bip32Path = null;
      expect(psbtInputFormatter(input).bip32Derivation).toEqual(
        MULTISIGS[0].bip32Derivation
      );
    });
  });

  describe("psbtOutputFormatter", () => {
    it(`returns the generated bip32Derivation for an output`, () => {
      const output = MULTISIGS[0].transaction.outputs[1];

      const changePublicKeys = MULTISIGS[0].changePublicKeys || [];
      const changeMultisig = generateMultisigFromPublicKeys(
        MULTISIGS[0].network,
        MULTISIGS[0].type,
        2,
        ...changePublicKeys
      );
      if (changeMultisig) {
        (changeMultisig as any).braidDetails = braidConfig(
          MULTISIGS[0].changeBraidDetails
        );
        (changeMultisig as any).bip32Derivation =
          MULTISIGS[0].changeBip32Derivation;
      }

      output.multisig = changeMultisig;
      expect(MULTISIGS[0].transaction.outputs[1]).toEqual(
        expect.objectContaining(psbtOutputFormatter(output))
      );
    });
  });

  describe("translatePSBT", () => {
    it("throws error with non-p2sh address type", () => {
      expect(() =>
        translatePSBT(
          tx.network,
          P2WSH,
          {},
          {
            xfp: ROOT_FINGERPRINT,
            path: "m/45'/1'/100'",
          }
        )
      ).toThrow(/Unsupported addressType/i);
    });

    it(`returns the inputs/outputs translated from the psbt`, () => {
      const result = translatePSBT(tx.network, tx.format, tx.psbt, {
        xfp: ROOT_FINGERPRINT,
        path: "m/45'/1'/100'",
      });
      if (result) {
        const { unchainedInputs, unchainedOutputs, bip32Derivations } = result;

        // We can't compare directly because our fixtures contain
        // additional information, so we will build our expected
        // returned values from other parts of the fixtures while
        // only sending in the psbt to the function we are testing.

        // FIXME - this is specific to P2SH
        const expectedInputs = tx.inputs.map((input) => ({
          amountSats: input.value,
          index: input.index,
          transactionHex: input.transactionHex,
          txid: input.txid,
          multisig: generateMultisigFromHex(
            tx.network,
            tx.format,
            ms.redeemScriptHex
          ),
        }));
        expect(unchainedInputs).toEqual(expectedInputs);

        // Same as above, building expected object from a
        // different set of data in the fixtures while the
        // returned data is translated from the PSBT itself.
        const expectedOutputs = tx.outputs.map((output) => ({
          address: output.address,
          amountSats: output.value,
        }));

        expect(unchainedOutputs).toEqual(expectedOutputs);

        expect(bip32Derivations.map((b32d) => b32d.path)).toEqual(
          tx.bip32Paths
        );
      }
    });

    it("should return null with non-string PSBT input", () => {
      expect(
        translatePSBT(
          tx.network,
          tx.format,
          {},
          {
            xfp: ROOT_FINGERPRINT,
            path: "m/45'/1'/100'",
          }
        )
      ).toBeNull();
    });

    it("should throw on psbt missing details (include psbt for another tx)", () => {
      expect(() => {
        translatePSBT(tx.network, tx.format, TRANSACTIONS[1].psbt, {
          xfp: ROOT_FINGERPRINT,
          path: "m/45'/1'/100'",
        });
      }).toThrow(/signing key details not included/i);
    });
  });

  describe("addSignaturesToPSBT", () => {
    // Function expects Buffers but our fixtures are hex strings
    const signaturesAsBuffers = tx.signature.map((sig) =>
      Buffer.from(sig, "hex")
    );
    const signingPubKeyBuffer = Buffer.from(ms.publicKey, "hex");
    const pubKeys = Array(signaturesAsBuffers.length).fill(signingPubKeyBuffer);

    it("adds signatures to unsigned PSBT", () => {
      const psbtWithSignature = addSignaturesToPSBT(
        tx.network,
        tx.psbt,
        pubKeys,
        signaturesAsBuffers
      );

      expect(psbtWithSignature).toEqual(ms.psbtOrderedPartiallySigned);
    });

    it("throws validation error when trying to add valid signatures to the wrong pubkey", () => {
      const wrongPubKeys = Array(signaturesAsBuffers.length).fill(
        Buffer.from(ms.publicKeys[1], "hex")
      );

      expect(() =>
        addSignaturesToPSBT(
          tx.network,
          tx.psbt,
          wrongPubKeys,
          signaturesAsBuffers
        )
      ).toThrow(/invalid signature/i);
    });

    it("should return null with non-string PSBT input", () => {
      expect(
        addSignaturesToPSBT(tx.network, [], pubKeys, signaturesAsBuffers)
      ).toBeNull();
    });
  });

  const singleInputHexPSBT =
    "70736274ff0100530100000001656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da0000000000ffffffff01b3bff5050000000017a91420fd9addb8034a12ce353b8aa7f4faca50259b198700000000000100f702000000000101ba408eed9f0758c35eca8c0ef8e29cb63eed4c4d1b1349c989ce681f4f398f270000000017160014aba867b774169ca1e1bf635c204e3a4a80d7d0f9feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a02a29150100000017a9141d8a90a10f4ff666b36e797a4d00df9d36bd213c8702473044022004593ebe490574537724328a73b206863aea72b6b51b677e0aee6f7aa2afe54f0220560bd4a3665e34d559e96f77f6e6b619d214b36df04bcb58ffe0d74174cbd8e601210208741a0d458e76b355d1c274d78d8c165e207be0a5ff50623c0d63eb7932fa2f00000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081cefa5d9162d00008001000080000000800100000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c0000800000000000000000000000000000";
  const singleInputHexPSBT_partiallySigned =
    "70736274ff0100530100000001656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da0000000000ffffffff01b3bff5050000000017a91420fd9addb8034a12ce353b8aa7f4faca50259b198700000000000100f702000000000101ba408eed9f0758c35eca8c0ef8e29cb63eed4c4d1b1349c989ce681f4f398f270000000017160014aba867b774169ca1e1bf635c204e3a4a80d7d0f9feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a02a29150100000017a9141d8a90a10f4ff666b36e797a4d00df9d36bd213c8702473044022004593ebe490574537724328a73b206863aea72b6b51b677e0aee6f7aa2afe54f0220560bd4a3665e34d559e96f77f6e6b619d214b36df04bcb58ffe0d74174cbd8e601210208741a0d458e76b355d1c274d78d8c165e207be0a5ff50623c0d63eb7932fa2f000000002202029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828483045022100fd9862cc751bd99f4b77b7d80f86701ba67e667912b2497f83f0d67d95c976ed02205ae2c4f01a361498709a5605baee70b985a9882c55ad022a8fed71e588f135060101030401000000220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081cefa5d9162d0000800100008000000080010000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c0000800000000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae0000";
  const singleInputHexPSBT_fullySigned =
    "70736274ff0100530100000001656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da0000000000ffffffff01b3bff5050000000017a91420fd9addb8034a12ce353b8aa7f4faca50259b198700000000000100f702000000000101ba408eed9f0758c35eca8c0ef8e29cb63eed4c4d1b1349c989ce681f4f398f270000000017160014aba867b774169ca1e1bf635c204e3a4a80d7d0f9feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a02a29150100000017a9141d8a90a10f4ff666b36e797a4d00df9d36bd213c8702473044022004593ebe490574537724328a73b206863aea72b6b51b677e0aee6f7aa2afe54f0220560bd4a3665e34d559e96f77f6e6b619d214b36df04bcb58ffe0d74174cbd8e601210208741a0d458e76b355d1c274d78d8c165e207be0a5ff50623c0d63eb7932fa2f000000002202029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828483045022100fd9862cc751bd99f4b77b7d80f86701ba67e667912b2497f83f0d67d95c976ed02205ae2c4f01a361498709a5605baee70b985a9882c55ad022a8fed71e588f1350601220202315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f454830450221008d633eccf112996792f02d5f39eef951ac042b831517fa3d245ba9b31635d93302207a36defbe2ee3f5d771fce61a801c77e4a00a4ef9a7738c510462339436a60140101030401000000220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081cefa5d9162d00008001000080000000800100000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c000080000000000000000000000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae0000";

  const singleInputB64PSBT =
    "cHNidP8BAFMBAAAAAWVgmMs+5cFL4oxMuL9iJSC7+XFoRgJWd8BBfyxc7KnaAAAAAAD/////AbO/9QUAAAAAF6kUIP2a3bgDShLONTuKp/T6ylAlmxmHAAAAAAABAPcCAAAAAAEBukCO7Z8HWMNeyowO+OKctj7tTE0bE0nJic5oH085jycAAAAAFxYAFKuoZ7d0Fpyh4b9jXCBOOkqA19D5/v///wIA4fUFAAAAABepFPdFuQ8xKjgkmh4Fxds6L40Kyk/dh6AqKRUBAAAAF6kUHYqQoQ9P9mazbnl6TQDfnTa9ITyHAkcwRAIgBFk+vkkFdFN3JDKKc7IGhjrqcra1G2d+Cu5veqKv5U8CIFYL1KNmXjTVWelvd/bmthnSFLNt8EvLWP/g10F0y9jmASECCHQaDUWOdrNV0cJ0142MFl4ge+Cl/1BiPA1j63ky+i8AAAAAAQRpUiECMVy+Tq2hBkY+BMI4/6Pb8mp3rVBHrHacQ/RilSUmb0UhAp6Ga5KwLGhvibMgwM5MI5HuUxtNzP1xmu/IyqguQsgoIQO6jLhicWUJDC3KhxJ0dgse8CfYnG9U6wduVnpPbF6FCFOuIgYDuoy4YnFlCQwtyocSdHYLHvAn2JxvVOsHblZ6T2xehQgc76XZFi0AAIABAACAAAAAgAEAAAAAAAAAAAAAACIGAp6Ga5KwLGhvibMgwM5MI5HuUxtNzP1xmu/IyqguQsgoHPV+xl0tAACAAQAAgDIAAIAAAAAAAAAAAAAAAAAiBgIxXL5OraEGRj4Ewjj/o9vyanetUEesdpxD9GKVJSZvRRz1fsZdLQAAgAEAAIA8AACAAAAAAAAAAAAAAAAAAAA=";
  const singleInputB64PSBT_partiallySigned =
    "cHNidP8BAFMBAAAAAWVgmMs+5cFL4oxMuL9iJSC7+XFoRgJWd8BBfyxc7KnaAAAAAAD/////AbO/9QUAAAAAF6kUIP2a3bgDShLONTuKp/T6ylAlmxmHAAAAAAABAPcCAAAAAAEBukCO7Z8HWMNeyowO+OKctj7tTE0bE0nJic5oH085jycAAAAAFxYAFKuoZ7d0Fpyh4b9jXCBOOkqA19D5/v///wIA4fUFAAAAABepFPdFuQ8xKjgkmh4Fxds6L40Kyk/dh6AqKRUBAAAAF6kUHYqQoQ9P9mazbnl6TQDfnTa9ITyHAkcwRAIgBFk+vkkFdFN3JDKKc7IGhjrqcra1G2d+Cu5veqKv5U8CIFYL1KNmXjTVWelvd/bmthnSFLNt8EvLWP/g10F0y9jmASECCHQaDUWOdrNV0cJ0142MFl4ge+Cl/1BiPA1j63ky+i8AAAAAIgICnoZrkrAsaG+JsyDAzkwjke5TG03M/XGa78jKqC5CyChIMEUCIQD9mGLMdRvZn0t3t9gPhnAbpn5meRKySX+D8NZ9lcl27QIgWuLE8Bo2FJhwmlYFuu5wuYWpiCxVrQIqj+1x5YjxNQYBAQMEAQAAACIGA7qMuGJxZQkMLcqHEnR2Cx7wJ9icb1TrB25Wek9sXoUIHO+l2RYtAACAAQAAgAAAAIABAAAAAAAAAAAAAAAiBgIxXL5OraEGRj4Ewjj/o9vyanetUEesdpxD9GKVJSZvRRz1fsZdLQAAgAEAAIA8AACAAAAAAAAAAAAAAAAAIgYCnoZrkrAsaG+JsyDAzkwjke5TG03M/XGa78jKqC5CyCgc9X7GXS0AAIABAACAMgAAgAAAAAAAAAAAAAAAAAEEaVIhAjFcvk6toQZGPgTCOP+j2/Jqd61QR6x2nEP0YpUlJm9FIQKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKCEDuoy4YnFlCQwtyocSdHYLHvAn2JxvVOsHblZ6T2xehQhTrgAA";
  const singleInputB64PSBT_fullySigned =
    "cHNidP8BAFMBAAAAAWVgmMs+5cFL4oxMuL9iJSC7+XFoRgJWd8BBfyxc7KnaAAAAAAD/////AbO/9QUAAAAAF6kUIP2a3bgDShLONTuKp/T6ylAlmxmHAAAAAAABAPcCAAAAAAEBukCO7Z8HWMNeyowO+OKctj7tTE0bE0nJic5oH085jycAAAAAFxYAFKuoZ7d0Fpyh4b9jXCBOOkqA19D5/v///wIA4fUFAAAAABepFPdFuQ8xKjgkmh4Fxds6L40Kyk/dh6AqKRUBAAAAF6kUHYqQoQ9P9mazbnl6TQDfnTa9ITyHAkcwRAIgBFk+vkkFdFN3JDKKc7IGhjrqcra1G2d+Cu5veqKv5U8CIFYL1KNmXjTVWelvd/bmthnSFLNt8EvLWP/g10F0y9jmASECCHQaDUWOdrNV0cJ0142MFl4ge+Cl/1BiPA1j63ky+i8AAAAAIgICnoZrkrAsaG+JsyDAzkwjke5TG03M/XGa78jKqC5CyChIMEUCIQD9mGLMdRvZn0t3t9gPhnAbpn5meRKySX+D8NZ9lcl27QIgWuLE8Bo2FJhwmlYFuu5wuYWpiCxVrQIqj+1x5YjxNQYBIgICMVy+Tq2hBkY+BMI4/6Pb8mp3rVBHrHacQ/RilSUmb0VIMEUCIQCNYz7M8RKZZ5LwLV857vlRrAQrgxUX+j0kW6mzFjXZMwIgejbe++LuP113H85hqAHHfkoApO+adzjFEEYjOUNqYBQBAQMEAQAAACIGA7qMuGJxZQkMLcqHEnR2Cx7wJ9icb1TrB25Wek9sXoUIHO+l2RYtAACAAQAAgAAAAIABAAAAAAAAAAAAAAAiBgKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKBz1fsZdLQAAgAEAAIAyAACAAAAAAAAAAAAAAAAAIgYCMVy+Tq2hBkY+BMI4/6Pb8mp3rVBHrHacQ/RilSUmb0Uc9X7GXS0AAIABAACAPAAAgAAAAAAAAAAAAAAAAAEEaVIhAjFcvk6toQZGPgTCOP+j2/Jqd61QR6x2nEP0YpUlJm9FIQKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKCEDuoy4YnFlCQwtyocSdHYLHvAn2JxvVOsHblZ6T2xehQhTrgAA";

  const multiInputHexPSBT =
    "70736274ff01007c0100000002cad3b4d5cf06d27b73648e9732d40de9e998b368126f7115ac0d37a356e9df670000000000ffffffff656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da0000000000ffffffff01b283eb0b0000000017a91420fd9addb8034a12ce353b8aa7f4faca50259b198700000000000100f702000000000101656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da01000000171600147f90bdaab2ccf30b942d996981055542accac7d0feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a83c330f0100000017a914e99068d54e242637cfa6552c02123cc838cff89c87024730440220107e098aa78369acb8bcd86c3a18da1101894c1ff260be143dfafb33d1d04296022063cf9a2f413a52f4e101c80a5ec0eaa1ae220506fe5ee75295eb7f842ae1a1810121034aad7b2fb8454327d36b8961f7a31816e7fa709fa15217d013837837d3a193f668000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081c83471e782d00008001000080000000800100000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c000080000000000000000000000000000100f702000000000101ba408eed9f0758c35eca8c0ef8e29cb63eed4c4d1b1349c989ce681f4f398f270000000017160014aba867b774169ca1e1bf635c204e3a4a80d7d0f9feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a02a29150100000017a9141d8a90a10f4ff666b36e797a4d00df9d36bd213c8702473044022004593ebe490574537724328a73b206863aea72b6b51b677e0aee6f7aa2afe54f0220560bd4a3665e34d559e96f77f6e6b619d214b36df04bcb58ffe0d74174cbd8e601210208741a0d458e76b355d1c274d78d8c165e207be0a5ff50623c0d63eb7932fa2f00000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081c83471e782d00008001000080000000800100000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c0000800000000000000000000000000000";
  const multiInputHexPSBT_partiallySigned =
    "70736274ff01007c0100000002cad3b4d5cf06d27b73648e9732d40de9e998b368126f7115ac0d37a356e9df670000000000ffffffff656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da0000000000ffffffff01b283eb0b0000000017a91420fd9addb8034a12ce353b8aa7f4faca50259b198700000000000100f702000000000101656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da01000000171600147f90bdaab2ccf30b942d996981055542accac7d0feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a83c330f0100000017a914e99068d54e242637cfa6552c02123cc838cff89c87024730440220107e098aa78369acb8bcd86c3a18da1101894c1ff260be143dfafb33d1d04296022063cf9a2f413a52f4e101c80a5ec0eaa1ae220506fe5ee75295eb7f842ae1a1810121034aad7b2fb8454327d36b8961f7a31816e7fa709fa15217d013837837d3a193f6680000002202029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828483045022100bc321b8f03605800e6ccefeba62e8c95e897fdfa2611b2531528b45c5c8c3e9a02200e4497e3abbbbe7aee0dca97363801fc306f22d0aa6c7f81775a11fb1f8159820101030401000000220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081cefa5d9162d0000800100008000000080010000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c0000800000000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae000100f702000000000101ba408eed9f0758c35eca8c0ef8e29cb63eed4c4d1b1349c989ce681f4f398f270000000017160014aba867b774169ca1e1bf635c204e3a4a80d7d0f9feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a02a29150100000017a9141d8a90a10f4ff666b36e797a4d00df9d36bd213c8702473044022004593ebe490574537724328a73b206863aea72b6b51b677e0aee6f7aa2afe54f0220560bd4a3665e34d559e96f77f6e6b619d214b36df04bcb58ffe0d74174cbd8e601210208741a0d458e76b355d1c274d78d8c165e207be0a5ff50623c0d63eb7932fa2f000000002202029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828483045022100a41cd24ac399c24449334d0a46906626de003e2b88a9c37e46f2cb0cbfbac0f602203c7524ec1c8f12d535a2212632865da1bef43bbe81c1b20ead12b6cbf7f44f9a0101030401000000220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081cefa5d9162d0000800100008000000080010000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c0000800000000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae0000";
  const multiInputHexPSBT_fullySigned =
    "70736274ff01007c0100000002cad3b4d5cf06d27b73648e9732d40de9e998b368126f7115ac0d37a356e9df670000000000ffffffff656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da0000000000ffffffff01b283eb0b0000000017a91420fd9addb8034a12ce353b8aa7f4faca50259b198700000000000100f702000000000101656098cb3ee5c14be28c4cb8bf622520bbf9716846025677c0417f2c5ceca9da01000000171600147f90bdaab2ccf30b942d996981055542accac7d0feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a83c330f0100000017a914e99068d54e242637cfa6552c02123cc838cff89c87024730440220107e098aa78369acb8bcd86c3a18da1101894c1ff260be143dfafb33d1d04296022063cf9a2f413a52f4e101c80a5ec0eaa1ae220506fe5ee75295eb7f842ae1a1810121034aad7b2fb8454327d36b8961f7a31816e7fa709fa15217d013837837d3a193f6680000002202029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828483045022100bc321b8f03605800e6ccefeba62e8c95e897fdfa2611b2531528b45c5c8c3e9a02200e4497e3abbbbe7aee0dca97363801fc306f22d0aa6c7f81775a11fb1f81598201220202315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f45483045022100aaba7f8f34b6cf733a79aabb4dbe4933ae9e1b0b3b738f3604c0db0001a1130502200a20844364bbc0a15c73209063a5546d4c7b57d5eb70bc06af2c29f25bf690020101030401000000220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081cefa5d9162d00008001000080000000800100000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c000080000000000000000000000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae000100f702000000000101ba408eed9f0758c35eca8c0ef8e29cb63eed4c4d1b1349c989ce681f4f398f270000000017160014aba867b774169ca1e1bf635c204e3a4a80d7d0f9feffffff0200e1f5050000000017a914f745b90f312a38249a1e05c5db3a2f8d0aca4fdd87a02a29150100000017a9141d8a90a10f4ff666b36e797a4d00df9d36bd213c8702473044022004593ebe490574537724328a73b206863aea72b6b51b677e0aee6f7aa2afe54f0220560bd4a3665e34d559e96f77f6e6b619d214b36df04bcb58ffe0d74174cbd8e601210208741a0d458e76b355d1c274d78d8c165e207be0a5ff50623c0d63eb7932fa2f000000002202029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828483045022100a41cd24ac399c24449334d0a46906626de003e2b88a9c37e46f2cb0cbfbac0f602203c7524ec1c8f12d535a2212632865da1bef43bbe81c1b20ead12b6cbf7f44f9a01220202315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4548304502210087f1b5e9dfe975afe8b656d49074f0dc835eebd0fd528b3663439ab2704d5769022008485a274b34b57f0d1d899633b7dc069c7bab5483b22dc77bf072c3c9e7a48a0101030401000000220603ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e85081cefa5d9162d00008001000080000000800100000000000000000000002206029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8281cf57ec65d2d0000800100008032000080000000000000000000000000220602315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f451cf57ec65d2d000080010000803c000080000000000000000000000000010469522102315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f4521029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c8282103ba8cb8627165090c2dca871274760b1ef027d89c6f54eb076e567a4f6c5e850853ae0000";

  const multiInputB64PSBT =
    "cHNidP8BAHwBAAAAAsrTtNXPBtJ7c2SOlzLUDenpmLNoEm9xFawNN6NW6d9nAAAAAAD/////ZWCYyz7lwUvijEy4v2IlILv5cWhGAlZ3wEF/LFzsqdoAAAAAAP////8BsoPrCwAAAAAXqRQg/ZrduANKEs41O4qn9PrKUCWbGYcAAAAAAAEA9wIAAAAAAQFlYJjLPuXBS+KMTLi/YiUgu/lxaEYCVnfAQX8sXOyp2gEAAAAXFgAUf5C9qrLM8wuULZlpgQVVQqzKx9D+////AgDh9QUAAAAAF6kU90W5DzEqOCSaHgXF2zovjQrKT92HqDwzDwEAAAAXqRTpkGjVTiQmN8+mVSwCEjzIOM/4nIcCRzBEAiAQfgmKp4NprLi82Gw6GNoRAYlMH/JgvhQ9+vsz0dBClgIgY8+aL0E6UvThAcgKXsDqoa4iBQb+XudSlet/hCrhoYEBIQNKrXsvuEVDJ9NriWH3oxgW5/pwn6FSF9ATg3g306GT9mgAAAABBGlSIQIxXL5OraEGRj4Ewjj/o9vyanetUEesdpxD9GKVJSZvRSECnoZrkrAsaG+JsyDAzkwjke5TG03M/XGa78jKqC5CyCghA7qMuGJxZQkMLcqHEnR2Cx7wJ9icb1TrB25Wek9sXoUIU64iBgO6jLhicWUJDC3KhxJ0dgse8CfYnG9U6wduVnpPbF6FCByDRx54LQAAgAEAAIAAAACAAQAAAAAAAAAAAAAAIgYCnoZrkrAsaG+JsyDAzkwjke5TG03M/XGa78jKqC5CyCgc9X7GXS0AAIABAACAMgAAgAAAAAAAAAAAAAAAACIGAjFcvk6toQZGPgTCOP+j2/Jqd61QR6x2nEP0YpUlJm9FHPV+xl0tAACAAQAAgDwAAIAAAAAAAAAAAAAAAAAAAQD3AgAAAAABAbpAju2fB1jDXsqMDvjinLY+7UxNGxNJyYnOaB9POY8nAAAAABcWABSrqGe3dBacoeG/Y1wgTjpKgNfQ+f7///8CAOH1BQAAAAAXqRT3RbkPMSo4JJoeBcXbOi+NCspP3YegKikVAQAAABepFB2KkKEPT/Zms255ek0A3502vSE8hwJHMEQCIARZPr5JBXRTdyQyinOyBoY66nK2tRtnfgrub3qir+VPAiBWC9SjZl401Vnpb3f25rYZ0hSzbfBLy1j/4NdBdMvY5gEhAgh0Gg1FjnazVdHCdNeNjBZeIHvgpf9QYjwNY+t5MvovAAAAAAEEaVIhAjFcvk6toQZGPgTCOP+j2/Jqd61QR6x2nEP0YpUlJm9FIQKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKCEDuoy4YnFlCQwtyocSdHYLHvAn2JxvVOsHblZ6T2xehQhTriIGA7qMuGJxZQkMLcqHEnR2Cx7wJ9icb1TrB25Wek9sXoUIHINHHngtAACAAQAAgAAAAIABAAAAAAAAAAAAAAAiBgKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKBz1fsZdLQAAgAEAAIAyAACAAAAAAAAAAAAAAAAAIgYCMVy+Tq2hBkY+BMI4/6Pb8mp3rVBHrHacQ/RilSUmb0Uc9X7GXS0AAIABAACAPAAAgAAAAAAAAAAAAAAAAAAA";
  const multiInputB64PSBT_partiallySigned =
    "cHNidP8BAHwBAAAAAsrTtNXPBtJ7c2SOlzLUDenpmLNoEm9xFawNN6NW6d9nAAAAAAD/////ZWCYyz7lwUvijEy4v2IlILv5cWhGAlZ3wEF/LFzsqdoAAAAAAP////8BsoPrCwAAAAAXqRQg/ZrduANKEs41O4qn9PrKUCWbGYcAAAAAAAEA9wIAAAAAAQFlYJjLPuXBS+KMTLi/YiUgu/lxaEYCVnfAQX8sXOyp2gEAAAAXFgAUf5C9qrLM8wuULZlpgQVVQqzKx9D+////AgDh9QUAAAAAF6kU90W5DzEqOCSaHgXF2zovjQrKT92HqDwzDwEAAAAXqRTpkGjVTiQmN8+mVSwCEjzIOM/4nIcCRzBEAiAQfgmKp4NprLi82Gw6GNoRAYlMH/JgvhQ9+vsz0dBClgIgY8+aL0E6UvThAcgKXsDqoa4iBQb+XudSlet/hCrhoYEBIQNKrXsvuEVDJ9NriWH3oxgW5/pwn6FSF9ATg3g306GT9mgAAAAiAgKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKEgwRQIhALwyG48DYFgA5szv66YujJXol/36JhGyUxUotFxcjD6aAiAORJfjq7u+eu4Nypc2OAH8MG8i0Kpsf4F3WhH7H4FZggEBAwQBAAAAIgYDuoy4YnFlCQwtyocSdHYLHvAn2JxvVOsHblZ6T2xehQgcg0ceeC0AAIABAACAAAAAgAEAAAAAAAAAAAAAACIGAjFcvk6toQZGPgTCOP+j2/Jqd61QR6x2nEP0YpUlJm9FHPV+xl0tAACAAQAAgDwAAIAAAAAAAAAAAAAAAAAiBgKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKBz1fsZdLQAAgAEAAIAyAACAAAAAAAAAAAAAAAAAAQRpUiECMVy+Tq2hBkY+BMI4/6Pb8mp3rVBHrHacQ/RilSUmb0UhAp6Ga5KwLGhvibMgwM5MI5HuUxtNzP1xmu/IyqguQsgoIQO6jLhicWUJDC3KhxJ0dgse8CfYnG9U6wduVnpPbF6FCFOuAAEA9wIAAAAAAQG6QI7tnwdYw17KjA744py2Pu1MTRsTScmJzmgfTzmPJwAAAAAXFgAUq6hnt3QWnKHhv2NcIE46SoDX0Pn+////AgDh9QUAAAAAF6kU90W5DzEqOCSaHgXF2zovjQrKT92HoCopFQEAAAAXqRQdipChD0/2ZrNueXpNAN+dNr0hPIcCRzBEAiAEWT6+SQV0U3ckMopzsgaGOupytrUbZ34K7m96oq/lTwIgVgvUo2ZeNNVZ6W939ua2GdIUs23wS8tY/+DXQXTL2OYBIQIIdBoNRY52s1XRwnTXjYwWXiB74KX/UGI8DWPreTL6LwAAAAAiAgKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKEgwRQIhAKQc0krDmcJESTNNCkaQZibeAD4riKnDfkbyywy/usD2AiA8dSTsHI8S1TWiISYyhl2hvvQ7voHBsg6tErbL9/RPmgEBAwQBAAAAIgYDuoy4YnFlCQwtyocSdHYLHvAn2JxvVOsHblZ6T2xehQgcg0ceeC0AAIABAACAAAAAgAEAAAAAAAAAAAAAACIGAjFcvk6toQZGPgTCOP+j2/Jqd61QR6x2nEP0YpUlJm9FHPV+xl0tAACAAQAAgDwAAIAAAAAAAAAAAAAAAAAiBgKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKBz1fsZdLQAAgAEAAIAyAACAAAAAAAAAAAAAAAAAAQRpUiECMVy+Tq2hBkY+BMI4/6Pb8mp3rVBHrHacQ/RilSUmb0UhAp6Ga5KwLGhvibMgwM5MI5HuUxtNzP1xmu/IyqguQsgoIQO6jLhicWUJDC3KhxJ0dgse8CfYnG9U6wduVnpPbF6FCFOuAAA=";
  const multiInputB64PSBT_fullySigned =
    "cHNidP8BAHwBAAAAAsrTtNXPBtJ7c2SOlzLUDenpmLNoEm9xFawNN6NW6d9nAAAAAAD/////ZWCYyz7lwUvijEy4v2IlILv5cWhGAlZ3wEF/LFzsqdoAAAAAAP////8BsoPrCwAAAAAXqRQg/ZrduANKEs41O4qn9PrKUCWbGYcAAAAAAAEA9wIAAAAAAQFlYJjLPuXBS+KMTLi/YiUgu/lxaEYCVnfAQX8sXOyp2gEAAAAXFgAUf5C9qrLM8wuULZlpgQVVQqzKx9D+////AgDh9QUAAAAAF6kU90W5DzEqOCSaHgXF2zovjQrKT92HqDwzDwEAAAAXqRTpkGjVTiQmN8+mVSwCEjzIOM/4nIcCRzBEAiAQfgmKp4NprLi82Gw6GNoRAYlMH/JgvhQ9+vsz0dBClgIgY8+aL0E6UvThAcgKXsDqoa4iBQb+XudSlet/hCrhoYEBIQNKrXsvuEVDJ9NriWH3oxgW5/pwn6FSF9ATg3g306GT9mgAAAAiAgKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKEgwRQIhALwyG48DYFgA5szv66YujJXol/36JhGyUxUotFxcjD6aAiAORJfjq7u+eu4Nypc2OAH8MG8i0Kpsf4F3WhH7H4FZggEiAgIxXL5OraEGRj4Ewjj/o9vyanetUEesdpxD9GKVJSZvRUgwRQIhAKq6f480ts9zOnmqu02+STOunhsLO3OPNgTA2wABoRMFAiAKIIRDZLvAoVxzIJBjpVRtTHtX1etwvAavLCnyW/aQAgEBAwQBAAAAIgYDuoy4YnFlCQwtyocSdHYLHvAn2JxvVOsHblZ6T2xehQgcg0ceeC0AAIABAACAAAAAgAEAAAAAAAAAAAAAACIGAp6Ga5KwLGhvibMgwM5MI5HuUxtNzP1xmu/IyqguQsgoHPV+xl0tAACAAQAAgDIAAIAAAAAAAAAAAAAAAAAiBgIxXL5OraEGRj4Ewjj/o9vyanetUEesdpxD9GKVJSZvRRz1fsZdLQAAgAEAAIA8AACAAAAAAAAAAAAAAAAAAQRpUiECMVy+Tq2hBkY+BMI4/6Pb8mp3rVBHrHacQ/RilSUmb0UhAp6Ga5KwLGhvibMgwM5MI5HuUxtNzP1xmu/IyqguQsgoIQO6jLhicWUJDC3KhxJ0dgse8CfYnG9U6wduVnpPbF6FCFOuAAEA9wIAAAAAAQG6QI7tnwdYw17KjA744py2Pu1MTRsTScmJzmgfTzmPJwAAAAAXFgAUq6hnt3QWnKHhv2NcIE46SoDX0Pn+////AgDh9QUAAAAAF6kU90W5DzEqOCSaHgXF2zovjQrKT92HoCopFQEAAAAXqRQdipChD0/2ZrNueXpNAN+dNr0hPIcCRzBEAiAEWT6+SQV0U3ckMopzsgaGOupytrUbZ34K7m96oq/lTwIgVgvUo2ZeNNVZ6W939ua2GdIUs23wS8tY/+DXQXTL2OYBIQIIdBoNRY52s1XRwnTXjYwWXiB74KX/UGI8DWPreTL6LwAAAAAiAgKehmuSsCxob4mzIMDOTCOR7lMbTcz9cZrvyMqoLkLIKEgwRQIhAKQc0krDmcJESTNNCkaQZibeAD4riKnDfkbyywy/usD2AiA8dSTsHI8S1TWiISYyhl2hvvQ7voHBsg6tErbL9/RPmgEiAgIxXL5OraEGRj4Ewjj/o9vyanetUEesdpxD9GKVJSZvRUgwRQIhAIfxtenf6XWv6LZW1JB08NyDXuvQ/VKLNmNDmrJwTVdpAiAISFonSzS1fw0diZYzt9wGnHurVIOyLcd78HLDyeekigEBAwQBAAAAIgYDuoy4YnFlCQwtyocSdHYLHvAn2JxvVOsHblZ6T2xehQgcg0ceeC0AAIABAACAAAAAgAEAAAAAAAAAAAAAACIGAp6Ga5KwLGhvibMgwM5MI5HuUxtNzP1xmu/IyqguQsgoHPV+xl0tAACAAQAAgDIAAIAAAAAAAAAAAAAAAAAiBgIxXL5OraEGRj4Ewjj/o9vyanetUEesdpxD9GKVJSZvRRz1fsZdLQAAgAEAAIA8AACAAAAAAAAAAAAAAAAAAQRpUiECMVy+Tq2hBkY+BMI4/6Pb8mp3rVBHrHacQ/RilSUmb0UhAp6Ga5KwLGhvibMgwM5MI5HuUxtNzP1xmu/IyqguQsgoIQO6jLhicWUJDC3KhxJ0dgse8CfYnG9U6wduVnpPbF6FCFOuAAA=";

  describe("parseSignaturesFromPSBT", () => {
    it("PSBT from file is neither hex nor base64", () => {
      expect(parseSignaturesFromPSBT("zzasdf")).toBeNull();
    });

    it("should return null if you send in a blank PSBT", () => {
      expect(
        parseSignaturesFromPSBT("cHNidP8BAAoCAAAAAAAAAAAAAAAA")
      ).toBeNull();
    });

    it("No signatures in the PSBT", () => {
      expect(parseSignaturesFromPSBT(singleInputB64PSBT)).toBeNull();
      expect(parseSignaturesFromPSBT(multiInputB64PSBT)).toBeNull();
    });

    it("Partially Signed PSBT, Single Input", () => {
      const oneSetOneInput = {
        "029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828": [
          "3045022100fd9862cc751bd99f4b77b7d80f86701ba67e667912b2497f83f0d67d95c976ed02205ae2c4f01a361498709a5605baee70b985a9882c55ad022a8fed71e588f1350601",
        ],
      };
      expect(
        parseSignaturesFromPSBT(singleInputB64PSBT_partiallySigned)
      ).toEqual(oneSetOneInput);
    });

    it("Partially Signed PSBT, Multiple Inputs", () => {
      const oneSetTwoInputs = {
        "029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828": [
          "3045022100bc321b8f03605800e6ccefeba62e8c95e897fdfa2611b2531528b45c5c8c3e9a02200e4497e3abbbbe7aee0dca97363801fc306f22d0aa6c7f81775a11fb1f81598201",
          "3045022100a41cd24ac399c24449334d0a46906626de003e2b88a9c37e46f2cb0cbfbac0f602203c7524ec1c8f12d535a2212632865da1bef43bbe81c1b20ead12b6cbf7f44f9a01",
        ],
      };
      expect(
        parseSignaturesFromPSBT(multiInputB64PSBT_partiallySigned)
      ).toEqual(oneSetTwoInputs);
    });

    it("Fully Signed PSBT, Single Input", () => {
      const twoSetsOneInput = {
        "02315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f45": [
          "30450221008d633eccf112996792f02d5f39eef951ac042b831517fa3d245ba9b31635d93302207a36defbe2ee3f5d771fce61a801c77e4a00a4ef9a7738c510462339436a601401",
        ],
        "029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828": [
          "3045022100fd9862cc751bd99f4b77b7d80f86701ba67e667912b2497f83f0d67d95c976ed02205ae2c4f01a361498709a5605baee70b985a9882c55ad022a8fed71e588f1350601",
        ],
      };
      expect(parseSignaturesFromPSBT(singleInputB64PSBT_fullySigned)).toEqual(
        twoSetsOneInput
      );
    });

    it("Fully Signed PSBT, Multiple Inputs", () => {
      const twoSetsTwoInputs = {
        "02315cbe4eada106463e04c238ffa3dbf26a77ad5047ac769c43f4629525266f45": [
          "3045022100aaba7f8f34b6cf733a79aabb4dbe4933ae9e1b0b3b738f3604c0db0001a1130502200a20844364bbc0a15c73209063a5546d4c7b57d5eb70bc06af2c29f25bf6900201",
          "304502210087f1b5e9dfe975afe8b656d49074f0dc835eebd0fd528b3663439ab2704d5769022008485a274b34b57f0d1d899633b7dc069c7bab5483b22dc77bf072c3c9e7a48a01",
        ],
        "029e866b92b02c686f89b320c0ce4c2391ee531b4dccfd719aefc8caa82e42c828": [
          "3045022100bc321b8f03605800e6ccefeba62e8c95e897fdfa2611b2531528b45c5c8c3e9a02200e4497e3abbbbe7aee0dca97363801fc306f22d0aa6c7f81775a11fb1f81598201",
          "3045022100a41cd24ac399c24449334d0a46906626de003e2b88a9c37e46f2cb0cbfbac0f602203c7524ec1c8f12d535a2212632865da1bef43bbe81c1b20ead12b6cbf7f44f9a01",
        ],
      };
      expect(parseSignaturesFromPSBT(multiInputB64PSBT_fullySigned)).toEqual(
        twoSetsTwoInputs
      );
    });
  });

  describe("parseSignatureArrayFromPSBT", () => {
    it("PSBT from file is neither hex nor base64", () => {
      expect(parseSignatureArrayFromPSBT("zzasdf")).toBeNull();
    });

    it("should return null if you send in a blank PSBT", () => {
      expect(
        parseSignatureArrayFromPSBT("cHNidP8BAAoCAAAAAAAAAAAAAAAA")
      ).toBeNull();
    });

    it("No signatures in the PSBT", () => {
      expect(parseSignatureArrayFromPSBT(singleInputHexPSBT)).toBeNull();
      expect(parseSignatureArrayFromPSBT(multiInputHexPSBT)).toBeNull();
    });

    it("Partially Signed PSBT, Single Input", () => {
      const oneSetOneInput = [
        "3045022100fd9862cc751bd99f4b77b7d80f86701ba67e667912b2497f83f0d67d95c976ed02205ae2c4f01a361498709a5605baee70b985a9882c55ad022a8fed71e588f1350601",
      ];
      expect(
        parseSignatureArrayFromPSBT(singleInputHexPSBT_partiallySigned)
      ).toEqual(oneSetOneInput);
    });

    it("Partially Signed PSBT, Multiple Inputs", () => {
      const oneSetTwoInputs = [
        "3045022100bc321b8f03605800e6ccefeba62e8c95e897fdfa2611b2531528b45c5c8c3e9a02200e4497e3abbbbe7aee0dca97363801fc306f22d0aa6c7f81775a11fb1f81598201",
        "3045022100a41cd24ac399c24449334d0a46906626de003e2b88a9c37e46f2cb0cbfbac0f602203c7524ec1c8f12d535a2212632865da1bef43bbe81c1b20ead12b6cbf7f44f9a01",
      ];
      expect(
        parseSignatureArrayFromPSBT(multiInputHexPSBT_partiallySigned)
      ).toEqual(oneSetTwoInputs);
    });

    it("Fully Signed PSBT, Single Input", () => {
      const twoSetsOneInput = [
        [
          "3045022100fd9862cc751bd99f4b77b7d80f86701ba67e667912b2497f83f0d67d95c976ed02205ae2c4f01a361498709a5605baee70b985a9882c55ad022a8fed71e588f1350601",
        ],
        [
          "30450221008d633eccf112996792f02d5f39eef951ac042b831517fa3d245ba9b31635d93302207a36defbe2ee3f5d771fce61a801c77e4a00a4ef9a7738c510462339436a601401",
        ],
      ];
      expect(
        parseSignatureArrayFromPSBT(singleInputHexPSBT_fullySigned)
      ).toEqual(twoSetsOneInput);
    });

    it("Fully Signed PSBT, Multiple Inputs", () => {
      const twoSetsTwoInputs = [
        [
          "3045022100bc321b8f03605800e6ccefeba62e8c95e897fdfa2611b2531528b45c5c8c3e9a02200e4497e3abbbbe7aee0dca97363801fc306f22d0aa6c7f81775a11fb1f81598201",
          "3045022100a41cd24ac399c24449334d0a46906626de003e2b88a9c37e46f2cb0cbfbac0f602203c7524ec1c8f12d535a2212632865da1bef43bbe81c1b20ead12b6cbf7f44f9a01",
        ],
        [
          "3045022100aaba7f8f34b6cf733a79aabb4dbe4933ae9e1b0b3b738f3604c0db0001a1130502200a20844364bbc0a15c73209063a5546d4c7b57d5eb70bc06af2c29f25bf6900201",
          "304502210087f1b5e9dfe975afe8b656d49074f0dc835eebd0fd528b3663439ab2704d5769022008485a274b34b57f0d1d899633b7dc069c7bab5483b22dc77bf072c3c9e7a48a01",
        ],
      ];
      expect(
        parseSignatureArrayFromPSBT(multiInputHexPSBT_fullySigned)
      ).toEqual(twoSetsTwoInputs);
    });
  });

  describe("autoLoadPSBT", () => {
    it("should fail if you don't send a String", () => {
      expect(autoLoadPSBT([])).toBeNull();
      expect(autoLoadPSBT({})).toBeNull();
      expect(autoLoadPSBT(Buffer.from("foobar", "hex"))).toBeNull();
    });
  });
});
